{% extends "layouts/base.html" %}
{% load static %}
{% block title %} Dashboard {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
  <style>
    .myFileInput {
        display: none;
    }
    
    #btn.disabled {
      pointer-events: none;
      cursor: default;
    }
</style>
{% endblock stylesheets %}
{% block head %}

{% endblock head %}

{% block content %}
<div class="topbar_pages px-4 py-1">
  <h5 class="font-weight-bolder mb-0">Purchase Order</h5>
  <nav aria-label="breadcrumb">
      <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
        <li class="breadcrumb-item text-sm"><a href="{% url 'wayrem_supplier:supplier_profile' %}"><span class="sidebar-icon"><span class="fas fa-chart-pie"></span></span> Dashboard</a></li>
        <li class="breadcrumb-item active text-sm" aria-current="page">All Purchase Order</li>
      </ol>
  </nav>
</div>
<div class="subheader row mt-5">
  <div class="add_btn col-xl-7 col-lg-7 col-md-7"></div>
  <div class="col-xl-5 col-lg-5 px-0 py-3">
      <div class="row d-flex align-items-right">
          <div class="col-xl-6 col-lg-6 col-md-6" style="height:40px;"></div>
          <div class="col-xl-6 col-lg-6 col-md-6 px-2">
            <div class="input-group table_shadow">
                <span class="input-group-text text-body"><i aria-hidden="true" class="fas fa-search"></i></span>
                <input class="form-control product_search" placeholder="Search" type="search" id="table_search">
            </div>
          </div>
      </div>
  </div>
</div>
{% comment %} {% if messages %}
  {% for message in messages %}
    <div {% if message.tags %} class="alert alert-{{message.tags}} alert-dismissible fade show" {% endif %} role="alert">
      <strong> {{ message }}!</strong>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %} {% endcomment %}
<p class="m-0 text-left">
  {% if messages %} {% for message in messages %}
  <div {% if message.tags %} class="alert alert-{{message.tags}} alert-dismissible fade show" {% endif %} role="alert">
      <strong> {{ message }}</strong>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %} {% endif %}
  <span class="input-group submit" id="error1" style="color: #d12525;"></span>  
</p>
<div class="card mb-4">
  <div class="card-body px-0 pt-0 pb-2">
      <div class="table-responsive p-3">
        <table class="table align-items-center mb-0" id="filtertable">
          <thead>
              <tr>
                <th class="text-secondary text-sm font-weight-bolder opacity-7">Purchase Order</th>   
                <th class="text-secondary text-sm font-weight-bolder opacity-7">Process Order</th>
                <th class="text-secondary text-sm font-weight-bolder opacity-7">Status</th>
                {% comment %} <th class="text-secondary text-sm font-weight-bolder opacity-7">Date</th> {% endcomment %}
                <th class="text-secondary text-sm font-weight-bolder opacity-7">Raise Invoice</th>
                <th class="text-secondary text-sm font-weight-bolder opacity-7 text-center">Actions</th>
              </tr>
          </thead>
          <tbody>
            {% for item1 in cholist %}
              <tr>
                <td  class="text-sm font-weight-bold p-4">{{item1.po_name}}</span></td>
                <td  class="text-sm font-weight-bold p-4">
                  {% if 'approved' in item1.status or 'shipping order' in item1.status or 'preparing order' in item1.status or 'delivered' in item1.status %}
                  <a type="button"  id="btn" data-count="1" op-id ="{{item1.po_name}}" status="{{item1.status}}" class="btn btn-sm m-0 accept-action {% if 'approved' in item1.status or 'preparing order' in item1.status  or 'shipping order' in item1.status or 'delivered' in item1.status or 'declined' in item1.status %} disabled {% endif %}" href="{% url 'wayrem_supplier:po_status' item1.po_id %}?status=approved"  value="{% if 'approved' in item1.status %}Approved{% else %}Approve{% endif %}" 
                    {% if 'approved' in item1.status or 'delivered' in item1.status or 'preparing order' in item1.status or 'shipping order' in item1.status  %}style="background-color:#05A677; color:#fff"{% endif %} >          
                      {% if 'approved' in item1.status or 'delivered' in item1.status or 'preparing order' in item1.status or 'shipping order' in item1.status %} Approved {% else %} Approve {% endif %}              
                  </a> 
                  {% elif 'waiting for approval' in item1.status %}
                    <a type="button"  id="btn" data-count="1" op-id ="{{item1.po_name}}" status="{{item1.status}}" class="btn btn-sm m-0 accept-action {% if 'approved' in item1.status or 'preparing order' in item1.status  or 'shipping order' in item1.status or 'delivered' in item1.status or 'declined' in item1.status %} disabled {% endif %}" href="{% url 'wayrem_supplier:podetails' item1.po_id %}"  value="{% if 'approved' in item1.status %}Approved{% else %}Approve{% endif %}" 
                    {% if 'approved' in item1.status or 'delivered' in item1.status or 'preparing order' in item1.status or 'shipping order' in item1.status  %}style="background-color:#05A677; color:#fff"{% endif %} >          
                      {% if 'approved' in item1.status or 'delivered' in item1.status or 'preparing order' in item1.status or 'shipping order' in item1.status %} Approved {% else %} Approve {% endif %}              
                  </a> 
                    <button type="button" id="color_id" class="btn btn-sm m-0 deny-action" data-bs-toggle="modal" data-bs-target="#denyModal{{item1.po_id}}"  value="{% if 'declined' in item1.status %}Declined{% else %}Decline{% endif %}" {% if 'declined' in item1.status %}style="background-color:#FA5252; color:#fff;"{% endif %} {% if 'approved' in item1.status or 'preparing order' in item1.status  or 'shipping order' in item1.status or 'delivered' in item1.status or 'declined' in item1.status %} disabled {% endif %}>
                      {% if 'declined' in item1.status %} Declined {% else %} Decline {% endif %} 
                    </button>  
                  {% else %}
                    <button type="button" id="color_id" class="btn btn-sm m-0  deny-action" data-bs-toggle="modal" data-bs-target="#denyModal{{item1.po_id}}"  value="{% if 'declined' in item1.status %}Declined{% else %}Decline{% endif %}" {% if 'declined' in item1.status %}style="background-color:#FA5252; color:#fff;"{% endif %} {% if 'approved' in item1.status or 'preparing order' in item1.status  or 'shipping order' in item1.status or 'delivered' in item1.status or 'declined' in item1.status %} disabled {% endif %}>
                      {% if 'declined' in item1.status %} Declined {% else %} Decline {% endif %} 
                    </button>
                  {% endif %}
                  <!-- Modal -->
                  <div class="modal fade deny-modal" id="denyModal{{item1.po_id}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel"> {{item1.po_name | title}}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form method="POST" action="{% url 'wayrem_supplier:deny_comment' item1.po_id %}">
                            <div class="modal-body">
                              {% csrf_token %}
                              <label for="tags"><h6>Are you sure want to decline Purchase Order ?</h6></label>
                              <input type="text" id="tags" name="deny_comment_box" placeholder="Reason to decline the Purchase Order " class="form-control" required>                            
                                </div>
                                <div class="modal-footer">
                              <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Close</button>                        
                              <button type="submit" class="btn btn-danger">Decline</button>
                            </div>
                          </form>
                        </div>
                    </div>
                  </div>
                </td> 
                <td class="text-sm font-weight-bold p-4">
                   <div class="col">
                    {% if item1.status == 'declined' %}
                      <p class="font-weight-bold text-danger m-0"> Declined </p> 
                      {% elif item1.status == 'approved' or item1.status == 'preparing order' or item1.status == 'shipping order' %}
                      <form method="POST" id="delivered_form" >
                        {% csrf_token %}
                        <select class="form-select form-select-sm delivered_box" name="d_status" id="delivered_box" dataid="{{item1.po_id}}">
                          <option selected value="{{item1.status}}">{{item1.status|title}}</option>
                          {% if 'approved' in item1.status %}
                            {% if not 'preparing order' in item1.status %}
                              <option value="preparing order">Preparing Order</option>
                            {% endif %}
                          {% elif 'preparing order' in item1.status %}
                            {% if not 'shipping order' in item1.status %}
                            <option value="shipping order">Shipping Order</option>
                            {% endif %}
                          {% elif 'shipping order' in item1.status %}
                            {% if not 'delivered' in item1.status %}
                            <option value="delivered">Delivered</option>
                            {% endif %}
                          {% endif %}
                        </select> 
                                                
                      </form>    
                      
                      {% elif 'delivered' in item1.status %}
                      <p class="font-weight-bold text-success m-0"> Delivered </p>
                      {% else %}
                      <p class="font-weight-bold text-warning m-0">Waiting for approval </p>                 
                    {% endif %}                
                  </div>                            
                </td>
                {% comment %} <td class="text-sm font-weight-bold p-4">{{item1.created_at}}</span></td> {% endcomment %}
                <td class="text-sm font-weight-bold p-4">
                  <div class="col">
                    <form method="POST" action="{% url 'wayrem_supplier:uploadinvoice' %}" class="form-upload-invoice" poid="{{item1.po_name}}" enctype="multipart/form-data" >
                        {% csrf_token %}
                        <input type="hidden" name="po_name" value="{{item1.po_name}}" />
                        <input type="file" class="myFileInput" name="myFileInput" data-id="{{item1.po_name}}" accept="application/pdf" id="myFileInput{{forloop.counter}}" />
                    </form>
                    {% if 'declined' in item1.status %} -
                    {% elif  'delivered' in item1.status %}
                        <a type="button"  title="Download Invoice" class="Download_invoice text-dark" data-href="{% url 'wayrem_supplier:downloadinvoice' %}?invoice_no={{item1.po_name}}" data-id="{{item1.po_name}}">
                          <i class="p-2 fas fa fa-download " aria-hidden="true" ></i>
                        </a>                        
                    {% else %}
                    <a type="button" title="Upload Invoice" class="upload-invoice" value="Upload Invoice" data-id="{{item1.po_name}}">
                        <i class="p-2 fas fa-file-upload edit_action_btn" aria-hidden="true" ></i>
                    </a>
                    <a type="button" class="Download_invoice text-dark" status="{{item1.status}}" data-href="{% url 'wayrem_supplier:downloadinvoice' %}?invoice_no={{item1.po_name}}" title="Download Invoice" data-id="{{item1.po_name}}">
                      <i class="p-2 fas fa fa-download " aria-hidden="true" ></i>
                    </a>
                    {% endif %}
                  </div>
                </td>            
                <td class="text-sm font-weight-bold p-4 text-center">    
                  <a aria-expanded="true" class="nav-link text-body p-0 show" data-bs-toggle="dropdown" href="javascript:;" id="dropdownMenuButton">
                    <i class="fa fa-ellipsis-v text-xs" aria-hidden="true"></i>
                  </a>
                  <ul aria-labelledby="dropdownMenuButton" class="dropdown-menu dropdown-menu-end px-2 py-3 me-sm-n4 table_shadow" data-bs-popper="none">
                      <li class="mb-2">
                        <a type="button" href="{% url 'wayrem_supplier:podetails' item1.po_id %}" class="p-1 btn-sm" title="view">
                            <i class="p-2 fas fa-eye view_action_btn me-3"></i> Manage PO
                        </a>
                      </li>
                  </ul> 
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <nav class= "pt-3" aria-label="...">
          <ul class="pagination">
                <li class="page-item {% if not cholist.has_previous %}disabled{% endif %}">
                  <a class="page-link" {% if cholist.has_previous %} href="?page={{ cholist.previous_page_number }}"  {% endif %}>Previous</a>
                </li>
                {% if cholist.number|add:'-4' > 1 %}
                <li class="page-item"><a class="page-link" href="?page={{ cholist.number|add:'-5' }}">&hellip;</a></li>
            {% endif %}
    
            {% for num in cholist.paginator.page_range %}
              {% if num == cholist.number %}
                <li class="page-item active" aria-current="page">
                  <a class="page-link" href="#">{{ num }}</a>
                </li>
              {% elif num > cholist.number|add:'-5' and num < cholist.number|add:'5' %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
              {% endif %} 
            {% endfor %}
    
            {% if cholist.paginator.num_pages > cholist.number|add:'4' %}
                <li class="page-item"><a class="page-link" href="?page={{ cholist.number|add:'5' }}">&hellip;</a></li>
            {% endif %}
    
              <li class="page-item {% if not cholist.has_next %}disabled{% endif %}">
                <a class="page-link" {% if cholist.has_next %} href="?page={{ cholist.next_page_number }}" {% endif %}>Next</a>
              </li>
          </ul>
        </nav>
      </div>
  </div>
  <ul class="all-status-hidden" style="display: none;">
    <li value="preparing order">Preparing Order</li>
    <li value="shipping order">Shipping Order</li>
    <li value="delivered">Delivered</li>
  </ul>  
</div>

<script>
  $(document).ready(function () {
        oTable = $('#filtertable').DataTable({
            dom: 'rt',
            pageLength:25,
            'columnDefs': [{ 'orderable': false, 'targets': [3,4] }],
            "oLanguage": {
                "oPaginate": {
                    "sNext": '  Next',
                    "sPrevious": 'Previous'
                }
            },
            "fnDrawCallback": function (oSettings) {
                if (oSettings._iDisplayLength > oSettings.fnRecordsDisplay()) {
                    $(oSettings.nTableWrapper).find('.dataTables_paginate').hide();
                } else {
                    $(oSettings.nTableWrapper).find('.dataTables_paginate').show();
                }
            }
        });
        $('#table_search').keyup(function () {
            oTable.search($(this).val()).draw();
        })
        $("#table_search").on(
          "change keyup paste input", function() {
           oTable.search($(this).val()).draw();
          });
});


$(document).ready(function () { 
  $('.delivered_box').change(function(){
    $(this).find('option[value="'+$(this).val()+'"]').prev('option').remove();
    var nextoption = $('ul.all-status-hidden li[value="'+$(this).val()+'"]').next('li').attr('value');
    var nextoptiontxt = $('ul.all-status-hidden li[value="'+$(this).val()+'"]').next('li').text();
    $(this).find('option').after('<option value="'+nextoption+'">'+nextoptiontxt+'</option>');
  });

  $('.delivered_box').change(function(){
    
      var d_status = $(this).val();
      var id = $(this).attr('dataid');
      
      // console.log(d_status);
      if(d_status =='delivered') {
          $(this).parent('form').parent('.col').html('<p class="font-weight-bold text-success"> Delivered </p>')
          $(this).parent('form').remove();
      } 
      var url = "{% url 'wayrem_supplier:delivered_status' %}"
          $.ajax({                  // initialize an AJAX request
              url: url,                    // set the url of the request (= /persons/ajax/load-cities/ )
              data: {
                  'id' : id,
                  'd_status': d_status       // add the country id to the GET parameters
              },
              success: function (data) {                 
              }
          });
        });
      });

    $(".myFileInput").change(function () {
      var filedataid = $(this).attr("data-id");
      var extension = $(this).val().split('.').pop().toLowerCase();
      var validFileExtensions = ['pdf'];
      if(this.files[0].size > 2000000) {
        $('.upload-invoice[data-id = "'+ $(this).attr("data-id") +'"]').after('<span class="uploaderror errortable">Max allowed file size is 2 MB.</span>');   
        $(this).val('');     
      } else if ($.inArray(extension, validFileExtensions) == -1) {
        $('.upload-invoice[data-id = "'+ $(this).attr("data-id") +'"]').after('<span class="uploaderror errortable">Sorry!! Upload only pdf file.</span>'); 
        $(this).val('');              
      } else {
        //$(this).parents('form:first').submit();
        $('.form-upload-invoice[poid="'+$(this).attr("data-id")+'"]').submit();   

        setTimeout(function(){
          $('.uploaderror.errortable').remove();
          }, 9000);                 
      }
    });

    $('.upload-invoice').click(function(e){
      e.preventDefault();
      var acceptchk = $('.accept-action[op-id="'+$(this).attr('data-id')+'"]').attr('status');
      if(acceptchk=='waiting for approval'){
        $('.uploaderror.errortable').remove()
        $(this).after('<span class="uploaderror errortable">Please accept before raise invoice.</span>');
      } else if(acceptchk=='declined'){
        $('.uploaderror.errortable').remove();
        $(this).after('<span class="uploaderror errortable">Already declined this Purchase Order</span>');
      } else {
        $('.uploaderror.errortable').remove();
        $('.myFileInput[data-id="'+$(this).attr('data-id')+'"]').click();
      }
      setTimeout(function(){
        $('.uploaderror.errortable').remove();
        }, 9000)      
    });

    $('.Download_invoice').click(function(e){
      var status = $(this).attr('status');
      var thisa = $(this);
      if(status=='waiting for approval'){
        e.preventDefault();
        $('.uploaderror.errortable').remove()
        $(this).after('<span class="uploaderror errortable">Please raise invoice before download invoice.</span>');
      } else if(status=='declined'){
        $('.uploaderror.errortable').remove();
        $(this).after('<span class="uploaderror errortable">Already declined this Purchase Order</span>');
      } else {
        $('.uploaderror.errortable').remove();        
        var url1 = "{% url 'wayrem_supplier:invoice_status' %}"
        $.ajax({                  // initialize an AJAX request
            url: url1,                    // set the url of the request (= /persons/ajax/load-cities/ )
            data: {
                'invoice_no': $(this).attr('data-id')       // add the country id to the GET parameters
            },
            success: function (result) { 
              $('.uploaderror.errortable').remove();
              if(result=='False') {
                thisa.after('<span class="uploaderror errortable">Please upload invoice before download invoice.</span>');
              } else {
                window.location.replace(thisa.attr('data-href'));
                
              }
               
            }
        });
      }
      setTimeout(function(){
        $('.uploaderror.errortable').remove();
        }, 9000);
    });
</script>


{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
{% endblock javascripts %}
{% comment %} onchange="form.submit()" {% endcomment %}